{"version":3,"file":"NsisUpdater.js","sourceRoot":"","sources":["../src/NsisUpdater.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { execFile, execFileSync, spawn } from \"child_process\"\nimport { CancellationError, CancellationToken, DownloadOptions } from \"electron-builder-http\"\nimport { PublishConfiguration } from \"electron-builder-http/out/publishOptions\"\nimport { parseDn } from \"electron-builder-http/out/rfc2253Parser\"\nimport { VersionInfo } from \"electron-builder-http/out/updateInfo\"\nimport { mkdtemp, remove } from \"fs-extra-p\"\nimport { tmpdir } from \"os\"\nimport * as path from \"path\"\nimport \"source-map-support/register\"\nimport { AppUpdater } from \"./AppUpdater\"\nimport { DownloadedUpdateHelper } from \"./DownloadedUpdateHelper\"\nimport { DOWNLOAD_PROGRESS, FileInfo, UPDATE_DOWNLOADED } from \"./main\"\n\nexport class NsisUpdater extends AppUpdater {\n  private readonly downloadedUpdateHelper = new DownloadedUpdateHelper()\n\n  private quitAndInstallCalled = false\n  private quitHandlerAdded = false\n\n  constructor(options?: PublishConfiguration, app?: any) {\n    super(options, app)\n  }\n\n  /*** @private */\n  protected async doDownloadUpdate(versionInfo: VersionInfo, fileInfo: FileInfo, cancellationToken: CancellationToken) {\n    const downloadOptions: DownloadOptions = {\n      skipDirCreation: true,\n      headers: this.computeRequestHeaders(fileInfo),\n      cancellationToken,\n      sha2: fileInfo == null ? null : fileInfo.sha2,\n      sha512: fileInfo == null ? null : fileInfo.sha512,\n    }\n\n    const downloadedFile = this.downloadedUpdateHelper.getDownloadedFile(versionInfo, fileInfo)\n    if (downloadedFile != null) {\n      return downloadedFile\n    }\n\n    if (this.listenerCount(DOWNLOAD_PROGRESS) > 0) {\n      downloadOptions.onProgress = it => this.emit(DOWNLOAD_PROGRESS, it)\n    }\n\n    const tempDir = await mkdtemp(`${path.join(tmpdir(), \"up\")}-`)\n    const tempFile = path.join(tempDir, fileInfo.name)\n\n    const removeTempDirIfAny = () => {\n      this.downloadedUpdateHelper.clear()\n      return remove(tempDir)\n        .catch(error => {\n          // ignored\n        })\n    }\n\n    let signatureVerificationStatus\n    try {\n      await this.httpExecutor.download(fileInfo.url, tempFile, downloadOptions)\n      signatureVerificationStatus = await this.verifySignature(tempFile)\n    }\n    catch (e) {\n      await removeTempDirIfAny()\n\n      if (e instanceof CancellationError) {\n        this.emit(\"update-cancelled\", this.versionInfo)\n        this._logger.info(\"Cancelled\")\n      }\n      throw e\n    }\n\n    if (signatureVerificationStatus != null) {\n      await removeTempDirIfAny()\n      // noinspection ThrowInsideFinallyBlockJS\n      throw new Error(`New version ${this.versionInfo!.version} is not signed by the application owner: ${signatureVerificationStatus}`)\n    }\n\n    this._logger.info(`New version ${this.versionInfo!.version} has been downloaded to ${tempFile}`)\n    this.downloadedUpdateHelper.setDownloadedFile(tempFile, versionInfo, fileInfo)\n    this.addQuitHandler()\n    this.emit(UPDATE_DOWNLOADED, this.versionInfo)\n    return tempFile\n  }\n\n  // $certificateInfo = (Get-AuthenticodeSignature 'xxx\\yyy.exe'\n  // | where {$_.Status.Equals([System.Management.Automation.SignatureStatus]::Valid) -and $_.SignerCertificate.Subject.Contains(\"CN=siemens.com\")})\n  // | Out-String ; if ($certificateInfo) { exit 0 } else { exit 1 }\n  private async verifySignature(tempUpdateFile: string): Promise<string | null> {\n    let publisherName: Array<string> | string | null\n    try {\n      publisherName = (await this.configOnDisk.value).publisherName\n      if (publisherName == null) {\n        return null\n      }\n    }\n    catch (e) {\n      if (e.code === \"ENOENT\") {\n        // no app-update.yml\n        return null\n      }\n      throw e\n    }\n\n    return await new BluebirdPromise<string | null>((resolve, reject) => {\n      execFile(\"powershell.exe\", [`Get-AuthenticodeSignature '${tempUpdateFile}' | ConvertTo-Json -Compress`], {maxBuffer: 4 * 1024000, timeout: 60 * 1000}, (error, stdout, stderr) => {\n        if (error != null || stderr) {\n          try {\n            execFileSync(\"powershell.exe\", [\"ConvertTo-Json test\"], {timeout: 10 * 1000})\n          }\n          catch (testError) {\n            this._logger.warn(`Cannot execute ConvertTo-Json: ${testError.message}. Ignoring signature validation due to unsupported powershell version. Please upgrade to powershell 3 or higher.`)\n            resolve(null)\n            return\n          }\n\n          if (error != null) {\n            reject(error)\n            return\n          }\n\n          if (stderr) {\n            reject(new Error(`Cannot execute Get-AuthenticodeSignature: ${stderr}`))\n            return\n          }\n        }\n\n        const data = JSON.parse(stdout)\n        delete data.PrivateKey\n        delete data.IsOSBinary\n        delete data.SignatureType\n        const signerCertificate = data.SignerCertificate\n        if (signerCertificate != null) {\n          delete signerCertificate.Archived\n          delete signerCertificate.Extensions\n          delete signerCertificate.Handle\n          delete signerCertificate.HasPrivateKey\n          // duplicates data.SignerCertificate (contains RawData)\n          delete signerCertificate.SubjectName\n        }\n        delete data.Path\n\n        if (data.Status === 0) {\n          const name = parseDn(data.SignerCertificate.Subject).get(\"CN\")!\n          if ((Array.isArray(publisherName) ? publisherName : [publisherName]).includes(name)) {\n            resolve(null)\n            return\n          }\n        }\n\n        const result = JSON.stringify(data, (name, value) => name === \"RawData\" ? undefined : value, 2)\n        this._logger.info(`Sign verification failed, installer signed with incorrect certificate: ${result}`)\n        resolve(result)\n      })\n    })\n  }\n\n  private addQuitHandler() {\n    if (this.quitHandlerAdded) {\n      return\n    }\n\n    this.quitHandlerAdded = true\n\n    this.app.on(\"quit\", () => {\n      this._logger.info(\"Auto install update on quit\")\n      this.install(true, false)\n    })\n  }\n\n  quitAndInstall(isSilent: boolean = false, isForceRunAfter: boolean = false): void {\n    if (this.install(isSilent, isForceRunAfter)) {\n      this.app.quit()\n    }\n  }\n\n  private install(isSilent: boolean, isForceRunAfter: boolean): boolean {\n    if (this.quitAndInstallCalled) {\n      return false\n    }\n\n    const setupPath = this.downloadedUpdateHelper.file\n    if (!this.updateAvailable || setupPath == null) {\n      const message = \"No update available, can't quit and install\"\n      this.emit(\"error\", new Error(message), message)\n      return false\n    }\n\n    // prevent calling several times\n    this.quitAndInstallCalled = true\n\n    const args = [\"--updated\"]\n    if (isSilent) {\n      args.push(\"/S\")\n    }\n\n    if (isForceRunAfter) {\n      args.push(\"--force-run\")\n    }\n\n    const spawnOptions = {\n      detached: true,\n      stdio: \"ignore\",\n    }\n\n    try {\n      spawn(setupPath, args, spawnOptions)\n        .unref()\n    }\n    catch (e) {\n      // yes, such errors dispatched not as error event\n      // https://github.com/electron-userland/electron-builder/issues/1129\n      if ((e as any).code === \"UNKNOWN\" || (e as any).code === \"EACCES\") { // Node 8 sends errors: https://nodejs.org/dist/latest-v8.x/docs/api/errors.html#errors_common_system_errors\n        this._logger.info(\"Access denied or UNKNOWN error code on spawn, will be executed again using elevate\")\n        try {\n          spawn(path.join(process.resourcesPath!, \"elevate.exe\"), [setupPath].concat(args), spawnOptions)\n            .unref()\n        }\n        catch (e) {\n          this.dispatchError(e)\n        }\n      }\n      else {\n        this.dispatchError(e)\n      }\n    }\n\n    return true\n  }\n}"]}
